{% extends "base.html" %}

{% block title %}Bell Scheduler - ChurchBell System{% endblock %}

{% block content %}
<div class="card mb-3">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <strong>System Time:</strong> <span id="system-time" class="fw-bold"></span>
      </div>
      <a href="{{ url_for('dashboard') }}" class="btn btn-sm btn-secondary">Back to Dashboard</a>
    </div>
  </div>
</div>

<div class="card">
  <div class="card-header">
    <h5 class="mb-0">Scheduled Alarms</h5>
  </div>
  <div class="card-body">
    {% if alarms %}
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Day</th>
            <th>Time</th>
            <th>Sound</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% set days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"] %}
          {% for alarm in alarms %}
          <tr>
            <td>{{ days[alarm.day_of_week] }}</td>
            <td>{{ alarm.time_str }}</td>
            <td>{{ alarm.sound_path.split('/')[-1] }}</td>
            <td>
              {% if alarm.enabled %}
                <span class="badge bg-success">Enabled</span>
              {% else %}
                <span class="badge bg-secondary">Disabled</span>
              {% endif %}
            </td>
            <td>
              <a href="{{ url_for('edit_alarm', alarm_id=alarm.id) }}" class="btn btn-sm btn-primary">Edit</a>
              <a href="{{ url_for('toggle_alarm', alarm_id=alarm.id) }}" class="btn btn-sm btn-warning">Toggle</a>
              <a href="{{ url_for('delete_alarm', alarm_id=alarm.id) }}" 
                 class="btn btn-sm btn-danger"
                 onclick="return confirm('Delete this alarm?')">Delete</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text-muted">No alarms scheduled.</p>
    {% endif %}
  </div>
</div>

<div class="card">
  <div class="card-header">
    <h5 class="mb-0">{% if edit_day is defined and edit_day is not none %}Edit Alarm{% else %}Add New Alarm{% endif %}</h5>
  </div>
  <div class="card-body">
    {% if edit_day is defined and edit_day is not none %}
    <div class="alert alert-info mb-3">
      Editing alarm. Make changes and click "Save Alarm" or click "Cancel" to discard.
    </div>
    {% endif %}
    <form method="post" action="{{ url_for('add_alarm') }}">
      <div class="row">
        <div class="col-md-3 mb-3">
          <label class="form-label">Day</label>
          <select name="day_of_week" class="form-select" required>
            {% for i in range(7) %}
              <option value="{{ i }}" {% if edit_day is defined and edit_day is not none and i|int == edit_day|int %}selected{% endif %}>
                {{ ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"][i] }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3 mb-3">
          <label class="form-label">Time</label>
          <input type="time" name="time_str" class="form-control" 
                 value="{% if edit_time is defined and edit_time is not none %}{{ edit_time }}{% endif %}" required>
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label">Sound</label>
          <select name="sound_path" class="form-select" required>
            {% for s in sounds %}
              <option value="sounds/{{ s }}" {% if edit_sound is defined and edit_sound is not none and edit_sound.endswith(s) %}selected{% endif %}>
                {{ s }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2 mb-3 d-flex align-items-end">
          <div class="form-check">
            <input type="checkbox" name="enabled" class="form-check-input" id="enabled" 
                   {% if edit_enabled is defined and edit_enabled is not none and edit_enabled|int == 1 %}checked{% elif edit_day is not defined or edit_day is none %}checked{% endif %}>
            <label class="form-check-label" for="enabled">Enabled</label>
          </div>
        </div>
      </div>
      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary">{% if edit_day is defined and edit_day is not none %}Save Alarm{% else %}Add Alarm{% endif %}</button>
        {% if edit_day is defined and edit_day is not none %}
        <a href="{{ url_for('alarms') }}" class="btn btn-secondary">Cancel</a>
        {% endif %}
      </div>
    </form>
  </div>
</div>

<div class="card">
  <div class="card-header">
    <h5 class="mb-0">Sound Files</h5>
  </div>
  <div class="card-body">
    <form method="POST" action="{{ url_for('upload_sound') }}" enctype="multipart/form-data" class="mb-3">
      <div class="input-group">
        <input type="file" name="file" accept=".wav" class="form-control" required>
        <button type="submit" class="btn btn-primary">Upload</button>
      </div>
    </form>
    {% if sounds %}
    <div class="table-responsive">
      <table class="table table-sm">
        <thead>
          <tr>
            <th>Filename</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for s in sounds %}
          <tr>
            <td>{{ s }}</td>
            <td>
              <a href="{{ url_for('test_sound', filename=s) }}" 
                 class="btn btn-sm btn-secondary" 
                 onclick="testSound('{{ s }}', this); return false;"
                 title="Test sound: {{ s }}">Test</a>
              <a href="{{ url_for('delete_sound', filename=s) }}" 
                 class="btn btn-sm btn-danger"
                 onclick="return confirm('Delete {{ s }}?')">Delete</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text-muted">No sound files uploaded.</p>
    {% endif %}
  </div>
</div>

{% if volume is defined %}
<div class="card">
  <div class="card-header">
    <h5 class="mb-0">Volume Control</h5>
  </div>
  <div class="card-body">
    <div class="d-flex align-items-center gap-3">
      <label>Volume: <span id="volume-value">{{ volume }}%</span></label>
      <input type="range" class="form-range" id="volume-slider" min="0" max="100" value="{{ volume }}" 
             oninput="updateVolume(this.value)" style="flex: 1; max-width: 300px;">
    </div>
  </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
function updateVolume(value) {
  document.getElementById('volume-value').textContent = value + '%';
  fetch('/set_volume', {
    method: 'POST',
    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
    body: 'volume=' + value
  });
}

function updateSystemTime() {
  const now = new Date();
  const options = { 
    weekday: 'short',
    year: 'numeric', 
    month: 'short', 
    day: 'numeric',
    hour: '2-digit', 
    minute: '2-digit', 
    second: '2-digit',
    hour12: true
  };
  document.getElementById('system-time').textContent = now.toLocaleString('en-US', options);
}

function testSound(filename, buttonElement) {
  const originalText = buttonElement.textContent;
  buttonElement.textContent = 'Testing...';
  buttonElement.disabled = true;
  
  // Show command being executed
  const command = `pw-play /home/pi/ChurchBell/sounds/${filename}`;
  console.log('[TEST] Command:', command);
  
  // Create debug display
  const debugDiv = document.createElement('div');
  debugDiv.className = 'alert alert-info mt-2';
  debugDiv.id = 'test-debug-' + filename;
  debugDiv.innerHTML = `<strong>Testing:</strong> <code>${command}</code>`;
  buttonElement.parentElement.parentElement.appendChild(debugDiv);
  
  fetch(`/test_sound/${filename}`)
    .then(response => {
      if (response.ok) {
        debugDiv.className = 'alert alert-success mt-2';
        debugDiv.innerHTML = `<strong>Success!</strong> Command executed: <code>${command}</code>`;
        setTimeout(() => debugDiv.remove(), 3000);
      } else {
        return response.text().then(text => {
          debugDiv.className = 'alert alert-danger mt-2';
          debugDiv.innerHTML = `<strong>Error:</strong> ${text || 'Failed to play sound'}<br><code>${command}</code>`;
        });
      }
    })
    .catch(error => {
      debugDiv.className = 'alert alert-danger mt-2';
      debugDiv.innerHTML = `<strong>Error:</strong> ${error.message}<br><code>${command}</code>`;
    })
    .finally(() => {
      buttonElement.textContent = originalText;
      buttonElement.disabled = false;
    });
}

// Update time immediately and then every second
updateSystemTime();
setInterval(updateSystemTime, 1000);
</script>
{% endblock %}
