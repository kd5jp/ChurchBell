{% extends "base.html" %}
{% block content %}

<!-- ===========================
     TOP BAR WITH CLOCK
=========================== -->
<div class="top-bar mb-3 d-flex justify-content-between align-items-center">
  <div>
    Logged in as {{ session.username }}
    <span class="ms-4 fw-bold" id="system-clock"></span>
  </div>

  <div>
    <form method="post" action="{{ url_for('change_password') }}" class="d-inline">
      <input type="password" name="current_password" placeholder="Current" required>
      <input type="password" name="new_password" placeholder="New" required>
      <input type="password" name="confirm_password" placeholder="Confirm" required>
      <button type="submit">Change Password</button>
    </form>
    <a href="{{ url_for('logout') }}" class="ms-3">Logout</a>
  </div>
</div>

<script>
function updateClock() {
  const now = new Date();
  const clock = document.getElementById("system-clock");
  clock.textContent = now.toLocaleString();
}
setInterval(updateClock, 1000);
updateClock();
</script>

<!-- ===========================
     1. ALARMS SECTION
=========================== -->
<div class="card mb-4">
  <div class="card-header">
    <h3 class="mb-0">Alarms</h3>
  </div>

  <div class="card-body p-0">
    <table class="table table-striped mb-0">
      <thead class="table-light">
        <tr>
          <th>Day</th>
          <th>Time</th>
          <th>Sound</th>
          <th>Enabled</th>
          <th style="width: 240px;">Actions</th>
        </tr>
      </thead>

      <tbody>
        {% set days = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"] %}
        {% for alarm in alarms %}
        <form method="POST" action="{{ url_for('update_alarm', alarm_id=alarm.id) }}">
        <tr>
          <td>
            <select name="day" class="form-select form-select-sm">
              {% for i in range(7) %}
                <option value="{{ i }}" {% if i == alarm.day_of_week %}selected{% endif %}>
                  {{ days[i] }}
                </option>
              {% endfor %}
            </select>
          </td>

          <td>
            <input type="time" name="time" value="{{ alarm.time_str }}" class="form-control form-control-sm" required>
          </td>

          <td>
            <select name="sound" class="form-select form-select-sm">
              {% for s in sounds %}
                <option value="sounds/{{ s }}" {% if alarm.sound_path.endswith(s) %}selected{% endif %}>
                  {{ s }}
                </option>
              {% endfor %}
            </select>
          </td>

          <td class="text-center">
            <input type="checkbox" name="enabled" {% if alarm.enabled %}checked{% endif %}>
          </td>

          <td>
            <button type="submit" class="btn btn-sm btn-primary">Save</button>
            <a href="{{ url_for('toggle_alarm', alarm_id=alarm.id) }}" class="btn btn-sm btn-warning">Toggle</a>
            <a href="{{ url_for('delete_alarm', alarm_id=alarm.id) }}" class="btn btn-sm btn-danger">Delete</a>
            <a href="{{ url_for('test_sound', filename=alarm.sound_path.split('/')[-1]) }}" class="btn btn-sm btn-secondary">Test</a>
          </td>
        </tr>
        </form>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- ===========================
     2. ADD ALARM SECTION
=========================== -->
<div class="card mb-4">
  <div class="card-header">
    <h4 class="mb-0">Add Alarm</h4>
  </div>

  <div class="card-body">
    <form method="post" action="{{ url_for('add_alarm') }}" class="row g-3">

      <div class="col-md-3">
        <label class="form-label">Day</label>
        <select name="day_of_week" class="form-select">
          <option value="0">Monday</option>
          <option value="1">Tuesday</option>
          <option value="2">Wednesday</option>
          <option value="3">Thursday</option>
          <option value="4">Friday</option>
          <option value="5">Saturday</option>
          <option value="6">Sunday</option>
        </select>
      </div>

      <div class="col-md-3">
        <label class="form-label">Time</label>
        <input type="time" name="time_str" class="form-control" required>
      </div>

      <div class="col-md-4">
        <label class="form-label">Sound</label>
        <select name="sound_path" class="form-select">
          {% for s in sounds %}
            <option value="sounds/{{ s }}">{{ s }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-2 d-flex align-items-end">
        <div class="form-check">
          <input type="checkbox" name="enabled" class="form-check-input" checked>
          <label class="form-check-label">Enabled</label>
        </div>
      </div>

      <div class="col-12">
        <button type="submit" class="btn btn-success">Add Alarm</button>
      </div>

    </form>
  </div>
</div>

<!-- ===========================
     3. AVAILABLE SOUNDS SECTION
=========================== -->
<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h4 class="mb-0">Available Sounds</h4>

    <form method="POST" action="{{ url_for('upload_sound') }}" enctype="multipart/form-data" class="d-flex">
      <input type="file" name="file" accept=".wav" class="form-control form-control-sm me-2" required>
      <button type="submit" class="btn btn-primary btn-sm">Upload</button>
    </form>
  </div>

  <div class="card-body p-0">
    <table class="table table-hover mb-0">
      <thead class="table-light">
        <tr>
          <th>Filename</th>
          <th style="width: 200px;">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for s in sounds %}
        <tr>
          <td>{{ s }}</td>
          <td>
            <a href="{{ url_for('test_sound', filename=s) }}" class="btn btn-sm btn-secondary">Test</a>
            <a href="{{ url_for('delete_sound', filename=s) }}" class="btn btn-sm btn-danger">Delete</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% endblock %}
