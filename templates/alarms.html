{% extends "base.html" %}
{% block content %}

<div class="top-bar">
  <div>Logged in as {{ session.username }}</div>
  <div>
    <form method="post" action="{{ url_for('change_password') }}" class="inline-form">
      <input type="password" name="current_password" placeholder="Current" required>
      <input type="password" name="new_password" placeholder="New" required>
      <input type="password" name="confirm_password" placeholder="Confirm" required>
      <button type="submit">Change Password</button>
    </form>
    <a href="{{ url_for('logout') }}">Logout</a>
  </div>
</div>

<h2>Alarms</h2>

<table class="alarms-table">
  <thead>
    <tr>
      <th>Day</th>
      <th>Time</th>
      <th>Sound</th>
      <th>Enabled</th>
      <th>Actions</th>
    </tr>
  </thead>

  <tbody>
    {% set days = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"] %}
    {% for alarm in alarms %}
    <tr>
      <form method="POST" action="{{ url_for('update_alarm', alarm_id=alarm.id) }}">
        <td>
          <select name="day">
            {% for i in range(7) %}
              <option value="{{ i }}" {% if i == alarm.day_of_week %}selected{% endif %}>
                {{ days[i] }}
              </option>
            {% endfor %}
          </select>
        </td>

        <td>
          <input type="time" name="time" value="{{ alarm.time_str }}" required>
        </td>

        <td>
          <select name="sound">
            {% for s in sounds %}
              <option value="sounds/{{ s }}" {% if alarm.sound_path.endswith(s) %}selected{% endif %}>
                {{ s }}
              </option>
            {% endfor %}
          </select>
        </td>

        <td>
          <input type="checkbox" name="enabled" {% if alarm.enabled %}checked{% endif %}>
        </td>

        <td>
          <button type="submit">Save</button>
          <a href="{{ url_for('toggle_alarm', alarm_id=alarm.id) }}">Toggle</a>
          <a href="{{ url_for('delete_alarm', alarm_id=alarm.id) }}">Delete</a>
          <a href="{{ url_for('test_sound', filename=alarm.sound_path.split('/')[-1]) }}">Test</a>
        </td>
      </form>
    </tr>
    {% endfor %}
  </tbody>
</table>

<h3>Add Alarm</h3>
<form method="post" action="{{ url_for('add_alarm') }}" class="add-alarm-form">
  <label>Day of Week</label>
  <select name="day_of_week">
    <option value="0">Monday</option>
    <option value="1">Tuesday</option>
    <option value="2">Wednesday</option>
    <option value="3">Thursday</option>
    <option value="4">Friday</option>
    <option value="5">Saturday</option>
    <option value="6">Sunday</option>
  </select>

  <label>Time (HH:MM)</label>
  <input type="time" name="time_str" required>

  <label>Sound</label>
  <select name="sound_path">
    {% for s in sounds %}
      <option value="sounds/{{ s }}">{{ s }}</option>
    {% endfor %}
  </select>

  <label>
    <input type="checkbox" name="enabled" checked> Enabled
  </label>

  <button type="submit">Add</button>
</form>

<h3>Available Sounds</h3>
<form method="POST" action="{{ url_for('upload_sound') }}" enctype="multipart/form-data">
  <input type="file" name="file" accept=".wav" required>
  <button type="submit">Upload WAV</button>
</form>

<table class="sounds-table">
  <thead>
    <tr>
      <th>Filename</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for s in sounds %}
    <tr>
      <td>{{ s }}</td>
      <td>
        <a href="{{ url_for('test_sound', filename=s) }}">Test</a>
        <a href="{{ url_for('delete_sound', filename=s) }}">Delete</a>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<div class="volume-slider-container">
  <label for="volume">Volume: <span id="volume-value">{{ volume }}</span>%</label>
  <input type="range" id="volume" min="0" max="100" value="{{ volume }}">
</div>

<script>
const volumeSlider = document.getElementById('volume');
const volumeValue = document.getElementById('volume-value');

volumeSlider.addEventListener('input', () => {
  volumeValue.textContent = volumeSlider.value;
});

let volumeTimeout = null;
volumeSlider.addEventListener('change', () => {
  if (volumeTimeout) clearTimeout(volumeTimeout);
  volumeTimeout = setTimeout(() => {
    const formData = new FormData();
    formData.append('volume', volumeSlider.value);
    fetch('{{ url_for("set_volume") }}', {
      method: 'POST',
      body: formData,
      credentials: 'same-origin'
    });
  }, 200);
});
</script>

{% endblock %}
